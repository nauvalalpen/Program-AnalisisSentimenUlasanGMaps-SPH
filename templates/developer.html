{% extends "base.html" %} {% block content %}

<section class="py-8 lg:py-12 bg-slate-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header Section -->
    <div
      class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 gap-6"
      data-aos="fade-up"
    >
      <div>
        <h1
          class="text-3xl font-black text-slate-900 tracking-tight flex items-center"
        >
          <i class="fas fa-laptop-medical text-brand-600 mr-3"></i>
          Developer Console
        </h1>
        <p class="text-slate-500 mt-1 max-w-2xl">
          Pusat kendali evaluasi model AI, visualisasi teks, dan diagnostik
          komparatif.
        </p>
      </div>

      <a
        href="{{ url_for('download_report') }}"
        class="inline-flex items-center px-5 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 hover:text-brand-600 hover:border-brand-300 transition-all shadow-sm"
      >
        <i class="fas fa-file-pdf mr-2 text-rose-500"></i>
        Download Laporan Lengkap
      </a>
    </div>

    <!-- Model Health Check (The "Vitals") -->
    <div
      class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8"
      data-aos="fade-up"
      data-aos-delay="100"
    >
      <!-- Vitals Card -->
      <div
        class="lg:col-span-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"
        >
          <h2 class="font-bold text-slate-800 flex items-center">
            <i class="fas fa-heartbeat text-rose-500 mr-2"></i>
            Kesehatan Model
          </h2>
          <span class="text-xs font-mono text-slate-400">v1.0.2</span>
        </div>

        <div class="p-6">
          <!-- Accuracy Vitals -->
          <div class="flex justify-between items-end mb-6">
            <div>
              <p
                class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1"
              >
                Test Accuracy
              </p>
              <div class="text-4xl font-black text-brand-600">
                {{ metrics.accuracy }}
              </div>
            </div>
            <div class="text-right">
              <p
                class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-1"
              >
                Train Accuracy
              </p>
              <div class="text-2xl font-bold text-slate-400">
                {{ metrics.train_accuracy }}
              </div>
            </div>
          </div>

          <!-- Status Indicator -->
          <div
            class="rounded-lg p-4 border {% if metrics.status == 'Good Fit (Ideal)' %} bg-emerald-50 border-emerald-100 {% else %} bg-amber-50 border-amber-100 {% endif %}"
          >
            <div class="flex items-start space-x-3">
              <i
                class="fas {% if metrics.status == 'Good Fit (Ideal)' %}fa-check-circle text-emerald-500{% else %}fa-exclamation-triangle text-amber-500{% endif %} mt-1"
              ></i>
              <div>
                <h3
                  class="text-sm font-bold {% if metrics.status == 'Good Fit (Ideal)' %}text-emerald-800{% else %}text-amber-800{% endif %}"
                >
                  {{ metrics.status }}
                </h3>
                <p
                  class="text-xs mt-1 {% if metrics.status == 'Good Fit (Ideal)' %}text-emerald-700{% else %}text-amber-700{% endif %}"
                >
                  {{ metrics.advice }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Learning Curve -->
      <div
        class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
      >
        <div
          class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"
        >
          <h2 class="font-bold text-slate-800 flex items-center">
            <i class="fas fa-chart-area text-brand-600 mr-2"></i>
            Grafik Learning Curve
          </h2>
          <span class="text-xs text-slate-500"
            >Deteksi Overfitting/Underfitting</span
          >
        </div>
        <div
          class="p-6 flex items-center justify-center bg-white min-h-[250px]"
        >
          {% if learning_curve %}
          <img
            src="data:image/png;base64,{{ learning_curve }}"
            class="max-h-64 rounded shadow-sm border border-slate-100"
          />
          {% else %}
          <div class="text-center text-slate-400">
            <i class="fas fa-chart-line text-4xl mb-2"></i>
            <p class="text-sm">
              Grafik akan tersedia setelah proses training ulang.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Section 1: Global Metrics Grid -->
    <h3
      class="text-lg font-bold text-slate-800 mb-4 flex items-center"
      data-aos="fade-up"
    >
      <i class="fas fa-globe-asia mr-2 text-slate-400"></i> Global Performance
      Metrics
    </h3>
    <div
      class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8"
      data-aos="fade-up"
      data-aos-delay="200"
    >
      <!-- Accuracy -->
      <div
        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-brand-300 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-slate-400 uppercase"
            >Accuracy</span
          >
          <i class="fas fa-bullseye text-brand-200"></i>
        </div>
        <div class="text-3xl font-black text-slate-800">
          {{ metrics.accuracy }}<span class="text-sm text-slate-400 font-normal"
            >%</span
          >
        </div>
      </div>

      <!-- Precision -->
      <div
        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-emerald-300 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-slate-400 uppercase"
            >Precision</span
          >
          <i class="fas fa-crosshairs text-emerald-200"></i>
        </div>
        <div class="text-3xl font-black text-emerald-600">
          {{ metrics.precision }}<span
            class="text-sm text-slate-400 font-normal"
            >%</span
          >
        </div>
      </div>

      <!-- Recall -->
      <div
        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-amber-300 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-slate-400 uppercase">Recall</span>
          <i class="fas fa-filter text-amber-200"></i>
        </div>
        <div class="text-3xl font-black text-amber-600">
          {{ metrics.recall }}<span class="text-sm text-slate-400 font-normal"
            >%</span
          >
        </div>
      </div>

      <!-- F1 Score -->
      <div
        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-purple-300 transition-colors"
      >
        <div class="flex justify-between items-start mb-2">
          <span class="text-xs font-bold text-slate-400 uppercase"
            >F1 Score</span
          >
          <i class="fas fa-star text-purple-200"></i>
        </div>
        <div class="text-3xl font-black text-purple-600">
          {{ metrics.f1_score }}<span class="text-sm text-slate-400 font-normal"
            >%</span
          >
        </div>
      </div>
    </div>

    <!-- Global Wordclouds -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12" data-aos="fade-up">
      <!-- Positive -->
      <div
        class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
      >
        <div
          class="px-4 py-3 bg-emerald-50 border-b border-emerald-100 flex items-center justify-between"
        >
          <span class="font-bold text-emerald-800 text-sm"
            >Global Wordcloud: POSITIF</span
          >
          <i class="fas fa-smile text-emerald-500"></i>
        </div>
        <div class="p-4 flex justify-center">
          {% if wc_pos %}
          <img
            src="data:image/png;base64,{{ wc_pos }}"
            class="max-h-60 rounded"
          />
          {% else %}
          <p class="text-slate-400 text-sm py-10">Data tidak tersedia</p>
          {% endif %}
        </div>
      </div>

      <!-- Negative -->
      <div
        class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"
      >
        <div
          class="px-4 py-3 bg-rose-50 border-b border-rose-100 flex items-center justify-between"
        >
          <span class="font-bold text-rose-800 text-sm"
            >Global Wordcloud: NEGATIF</span
          >
          <i class="fas fa-frown text-rose-500"></i>
        </div>
        <div class="p-4 flex justify-center">
          {% if wc_neg %}
          <img
            src="data:image/png;base64,{{ wc_neg }}"
            class="max-h-60 rounded"
          />
          {% else %}
          <p class="text-slate-400 text-sm py-10">Data tidak tersedia</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Section 2: Wordcloud Viewer & Diagnostic -->
    <div
      class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8"
      data-aos="fade-up"
      data-aos-delay="300"
    >
      <!-- 2.1 Wordcloud Viewer -->
      <div
        class="bg-white rounded-xl border border-slate-200 shadow-sm h-full flex flex-col"
      >
        <div
          class="px-6 py-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
        >
          <h2 class="font-bold text-slate-800 flex items-center">
            <i class="fas fa-microscope text-brand-600 mr-2"></i>
            Wordcloud Viewer
          </h2>
          <select
            id="wcSelector"
            class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full sm:w-auto p-2"
          >
            <option value="">-- Pilih RS --</option>
            {% for rs in hospitals %}
            <option value="{{ rs }}">{{ rs }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="p-6 flex-grow">
          <!-- Loading -->
          <div
            id="loadingWC"
            class="hidden h-full flex flex-col items-center justify-center py-10"
          >
            <i
              class="fas fa-circle-notch fa-spin text-3xl text-brand-500 mb-3"
            ></i>
            <p class="text-slate-500 text-sm">Memuat visualisasi...</p>
          </div>

          <!-- Result -->
          <div id="wcResult" class="hidden grid grid-cols-2 gap-4">
            <div class="text-center">
              <p class="text-xs font-bold text-emerald-600 uppercase mb-2">
                Positif
              </p>
              <div
                class="bg-slate-50 rounded border border-slate-100 p-2 min-h-[150px] flex items-center justify-center"
              >
                <img id="imgPosSpecific" src="" class="w-full rounded hidden" />
                <p id="msgPosSpecific" class="text-xs text-slate-400 hidden">
                  Data Kurang
                </p>
              </div>
            </div>
            <div class="text-center">
              <p class="text-xs font-bold text-rose-600 uppercase mb-2">
                Negatif
              </p>
              <div
                class="bg-slate-50 rounded border border-slate-100 p-2 min-h-[150px] flex items-center justify-center"
              >
                <img id="imgNegSpecific" src="" class="w-full rounded hidden" />
                <p id="msgNegSpecific" class="text-xs text-slate-400 hidden">
                  Data Kurang
                </p>
              </div>
            </div>
          </div>

          <!-- Default State -->
          <div
            id="defaultWC"
            class="h-full flex items-center justify-center py-10 text-slate-400"
          >
            <p class="text-sm">
              Pilih rumah sakit untuk melihat distribusi kata.
            </p>
          </div>
        </div>
      </div>

      <!-- 2.2 Diagnostic Center -->
      <div
        class="bg-white rounded-xl border border-slate-200 shadow-sm h-full flex flex-col"
      >
        <div
          class="px-6 py-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"
        >
          <h2 class="font-bold text-slate-800 flex items-center">
            <i class="fas fa-stethoscope text-amber-500 mr-2"></i>
            Diagnostic Center
          </h2>
          <select
            id="diagSelector"
            class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block w-full sm:w-auto p-2"
          >
            <option value="">-- Pilih RS --</option>
            {% for rs in hospitals %}
            <option value="{{ rs }}">{{ rs }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="p-6 flex-grow">
          <!-- Loading -->
          <div
            id="loadingDiag"
            class="hidden h-full flex flex-col items-center justify-center py-10"
          >
            <i
              class="fas fa-circle-notch fa-spin text-3xl text-amber-500 mb-3"
            ></i>
            <p class="text-slate-500 text-sm">Menganalisis tren...</p>
          </div>

          <!-- Result -->
          <div id="diagResult" class="hidden space-y-4">
            <!-- AI Analysis Box -->
            <div
              class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm"
            >
              <h4
                class="font-bold text-slate-800 mb-2 border-b border-slate-200 pb-2"
              >
                Kesimpulan AI
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <span class="text-xs font-bold text-rose-600 uppercase"
                    >Analisis Keluhan</span
                  >
                  <p
                    id="txtAnalysisNeg"
                    class="text-slate-600 mt-1 text-xs leading-relaxed"
                  >
                    ...
                  </p>
                </div>
                <div>
                  <span class="text-xs font-bold text-emerald-600 uppercase"
                    >Analisis Kekuatan</span
                  >
                  <p
                    id="txtAnalysisPos"
                    class="text-slate-600 mt-1 text-xs leading-relaxed"
                  >
                    ...
                  </p>
                </div>
              </div>
            </div>

            <!-- Comparison -->
            <div class="grid grid-cols-2 gap-4">
              <!-- Past -->
              <div class="border border-slate-200 rounded-lg p-3">
                <p
                  class="text-xs font-bold text-slate-500 uppercase mb-2 text-center"
                >
                  Training Data (Past)
                </p>
                <img
                  id="imgNegPast"
                  src=""
                  class="w-full rounded mb-2 hidden"
                />
                <img id="imgPosPast" src="" class="w-full rounded hidden" />
              </div>
              <!-- Live -->
              <div
                class="border-2 border-brand-100 bg-brand-50/30 rounded-lg p-3"
              >
                <p
                  class="text-xs font-bold text-brand-600 uppercase mb-2 text-center"
                >
                  Live Data (Now)
                </p>
                <img
                  id="imgNegLive"
                  src=""
                  class="w-full rounded mb-2 hidden"
                />
                <p
                  id="msgNegLive"
                  class="text-xs text-center text-slate-400 hidden mb-2"
                >
                  No Data
                </p>
                <img id="imgPosLive" src="" class="w-full rounded hidden" />
                <p
                  id="msgPosLive"
                  class="text-xs text-center text-slate-400 hidden"
                >
                  No Data
                </p>
              </div>
            </div>

            <div class="text-right pt-2">
              <a
                id="btnDownloadSpecific"
                href="#"
                class="text-xs font-bold text-brand-600 hover:text-brand-800 hover:underline"
              >
                <i class="fas fa-download mr-1"></i>Download Report PDF
              </a>
            </div>
          </div>

          <!-- Default State -->
          <div
            id="defaultDiag"
            class="h-full flex items-center justify-center py-10 text-slate-400"
          >
            <p class="text-sm">Pilih rumah sakit untuk komparasi data.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Helper to hide default msg
  function showResults(containerId, defaultId) {
    document.getElementById(containerId).classList.remove("hidden");
    const def = document.getElementById(defaultId);
    if (def) def.classList.add("hidden");
  }

  // Section 2: Wordcloud Viewer
  document.getElementById("wcSelector").addEventListener("change", function () {
    const rsName = this.value;
    const loading = document.getElementById("loadingWC");
    const resultDiv = document.getElementById("wcResult");
    const defaultDiv = document.getElementById("defaultWC");

    if (!rsName) {
      resultDiv.classList.add("hidden");
      defaultDiv.classList.remove("hidden");
      return;
    }

    defaultDiv.classList.add("hidden");
    resultDiv.classList.add("hidden");
    loading.classList.remove("hidden");

    fetch("/api/get_wordcloud", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hospital: rsName }),
    })
      .then((res) => res.json())
      .then((data) => {
        loading.classList.add("hidden");
        resultDiv.classList.remove("hidden");

        // Positive wordcloud
        const imgPos = document.getElementById("imgPosSpecific");
        const msgPos = document.getElementById("msgPosSpecific");
        if (data.wc_pos) {
          imgPos.src = "data:image/png;base64," + data.wc_pos;
          imgPos.classList.remove("hidden");
          msgPos.classList.add("hidden");
        } else {
          imgPos.classList.add("hidden");
          msgPos.classList.remove("hidden");
        }
        // Negative wordcloud
        const imgNeg = document.getElementById("imgNegSpecific");
        const msgNeg = document.getElementById("msgNegSpecific");
        if (data.wc_neg) {
          imgNeg.src = "data:image/png;base64," + data.wc_neg;
          imgNeg.classList.remove("hidden");
          msgNeg.classList.add("hidden");
        } else {
          imgNeg.classList.add("hidden");
          msgNeg.classList.remove("hidden");
        }
      });
  });

  document
    .getElementById("diagSelector")
    .addEventListener("change", function () {
      const rsName = this.value;
      const loading = document.getElementById("loadingDiag");
      const resultDiv = document.getElementById("diagResult");
      const defaultDiv = document.getElementById("defaultDiag");

      if (!rsName) {
        resultDiv.classList.add("hidden");
        defaultDiv.classList.remove("hidden");
        return;
      }

      defaultDiv.classList.add("hidden");
      resultDiv.classList.add("hidden");
      loading.classList.remove("hidden");

      // Update download link
      document.getElementById("btnDownloadSpecific").href =
        "/api/download_report_specific/" + encodeURIComponent(rsName);

      fetch("/api/get_hospital_analysis", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hospital: rsName }),
      })
        .then((res) => res.json())
        .then((data) => {
          loading.classList.add("hidden");
          resultDiv.classList.remove("hidden");

          // Set analysis text
          document.getElementById("txtAnalysisNeg").innerText =
            data.analysis_neg || "Tidak ada data analisis negatif.";
          document.getElementById("txtAnalysisPos").innerText =
            data.analysis_pos || "Tidak ada data analisis positif.";

          // Helper function to set images
          const setImg = (imgId, msgId, b64) => {
            const img = document.getElementById(imgId);
            const msg = msgId ? document.getElementById(msgId) : null;

            if (b64) {
              img.src = "data:image/png;base64," + b64;
              img.classList.remove("hidden");
              if (msg) msg.classList.add("hidden");
            } else {
              img.classList.add("hidden");
              if (msg) msg.classList.remove("hidden");
            }
          };

          // Set all images
          setImg("imgNegPast", null, data.wc_neg_past);
          setImg("imgPosPast", null, data.wc_pos_past);
          setImg("imgNegLive", "msgNegLive", data.wc_neg_live);
          setImg("imgPosLive", "msgPosLive", data.wc_pos_live);
        });
    });
</script>
{% endblock %}
